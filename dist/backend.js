"use strict";const P=["BOOLEAN_OPERATION","COMPONENT","ELLIPSE","FRAME","INSTANCE","LINE","POLYGON","RECTANGLE","STAR","TEXT","VECTOR","SHAPE_WITH_TEXT","HIGHLIGHT"];function L(){var p,a,N,w;const o=figma.currentPage.selection,e={newColorsRgba:{parentFill:null,fill:null,stroke:null},uiMessageCode:null,nodeType:null};let l=!0,f=!0;if(!o[0])return e.uiMessageCode="no_selection",e;for(const t of o)if(!P.includes(t.type))return e.uiMessageCode="not_supported_type",e.nodeType=t.type,e;const n=o[0],s=n.fills[0],r=n.strokes[0];if(!s&&!r)return e.uiMessageCode="no_color_in_shape",e;if((s==null?void 0:s.type)!=="SOLID"&&(r==null?void 0:r.type)!=="SOLID")return e.uiMessageCode="no_solid_color",e;if((p=n.parent)!=null&&p.fills){let t=n.parent;for(;t;)if(t.fills&&((a=t==null?void 0:t.fills)==null?void 0:a.length)!==0){e.newColorsRgba.parentFill={r:t.fills[0].color.r*255,g:t.fills[0].color.g*255,b:t.fills[0].color.b*255};break}else if(t.parent)t=t.parent;else break}if(o.length>1){e.newColorsRgba.parentFill&&(e.newColorsRgba.parentFill=null);let t=0,m=0;for(const R of o)((N=R.fills[0])==null?void 0:N.type)==="SOLID"&&t++,((w=R.strokes[0])==null?void 0:w.type)==="SOLID"&&m++;if(o.length!==t&&o.length!==m)return e.uiMessageCode="not_all_shapes_have_fill_or_stroke",e;o.length!==t?l=!1:o.length!==m&&(f=!1)}return(s==null?void 0:s.type)==="SOLID"&&l&&(e.newColorsRgba.fill={r:s.color.r*255,g:s.color.g*255,b:s.color.b*255,a:Math.round(s.opacity*100)}),(r==null?void 0:r.type)==="SOLID"&&f&&(e.newColorsRgba.stroke={r:r.color.r*255,g:r.color.g*255,b:r.color.b*255,a:Math.round(r.opacity*100)}),e}const g={okhsvl:{colorCodes:564,noColorCodes:435},oklch:{contrastAndColorCodes:680,contrastAndNoColorCodes:550,noContrastAndColorCodes:647,noContrastAndNoColorCodes:517}};function T(o){const{currentColorModel:e,isColorCodeInputsOpen:l,isContrastInputOpen:f}=o;return["okhsv","okhsl"].includes(e)?l?g.okhsvl.colorCodes:g.okhsvl.noColorCodes:["oklch","oklchCss"].includes(e)?f?l?g.oklch.contrastAndColorCodes:g.oklch.contrastAndNoColorCodes:l?g.oklch.noContrastAndColorCodes:g.oklch.noContrastAndNoColorCodes:g.oklch.contrastAndColorCodes}function k(o){figma.ui.postMessage({type:o.type,data:o.data})}function H(o,e,l){var r;const f={r:o.r/255,g:o.g/255,b:o.b/255,a:o.a/100};let n;const s=e+"s";for(const p of figma.currentPage.selection){let a;if(l==="bg"){for(a=p.parent;a&&((r=a.fills)==null?void 0:r.length)===0;)if(a.parent)a=a.parent;else break;n=JSON.parse(JSON.stringify(a.fills))}else n=JSON.parse(JSON.stringify(p[s]));n[0].color.r=f.r,n[0].color.g=f.g,n[0].color.b=f.b,n[0].opacity=f.a,l==="bg"?a.fills=n:p[s]=n}}let i="fill",S,d,h,C,A,u,y,I=!1,c={parentFill:null,fill:null,stroke:null};const F=["fills","fillStyleId","strokes","strokeStyleId","strokeWeight","textStyleId"],O=()=>{const o=T({currentColorModel:d,isColorCodeInputsOpen:y,isContrastInputOpen:h});figma.ui.resize(240,o)},M=()=>{const o=L();return o.uiMessageCode?(k({type:"displayUiMessage",data:{uiMessageCode:o.uiMessageCode,nodeType:o.nodeType}}),"uiMessageCode sent"):(c=JSON.parse(JSON.stringify(o.newColorsRgba)),"colorsRgba updated")},J=async()=>{figma.editorType==="figma"?S=await figma.clientStorage.getAsync("fileColorProfile")||"rgb":figma.editorType==="figjam"&&(S="rgb"),h=await figma.clientStorage.getAsync("isContrastInputOpen")||!1,y=await figma.clientStorage.getAsync("isColorCodeInputsOpen")||!1,A=await figma.clientStorage.getAsync("currentContrastMethod")||"apca",d=await figma.clientStorage.getAsync("currentColorModel")||"oklchCss",d==="okhsv"||d==="okhsl"?(C=!1,u=!1):(C=await figma.clientStorage.getAsync("lockRelativeChroma")||!1,u=await figma.clientStorage.getAsync("lockContrast")||!1);const o=T({currentColorModel:d,isColorCodeInputsOpen:y,isContrastInputOpen:h});figma.showUI(__html__,{width:240,height:o,themeColors:!0})};J();const D=async()=>{k({type:"syncLocalStorageValues",data:{figmaEditorType:figma.editorType,fileColorProfile:S,isContrastInputOpen:h,lockRelativeChroma:C,currentContrastMethod:A,lockContrast:u,isColorCodeInputsOpen:y,currentColorModel:d}}),M()!=="uiMessageCode sent"&&(i=c.fill?"fill":"stroke",k({type:"syncNewShape",data:{currentFillOrStroke:i,colorsRgba:c,lockRelativeChroma:C,lockContrast:u}}))},_=()=>{M()!=="uiMessageCode sent"&&(i=c.fill?"fill":"stroke",k({type:"syncNewShape",data:{currentFillOrStroke:i,colorsRgba:c,lockRelativeChroma:C,lockContrast:u}}))},E=o=>{if(I||o.documentChanges[0].type!=="PROPERTY_CHANGE")return;if(o.documentChanges[0].properties.some(l=>F.includes(l))){const l=JSON.parse(JSON.stringify(c));if(M()==="uiMessageCode sent")return;JSON.stringify(l)!==JSON.stringify(c)&&(i==="fill"&&!c.fill?i="stroke":i==="stroke"&&!c.stroke&&(i="fill")),k({type:"syncNewShape",data:{currentFillOrStroke:i,colorsRgba:c,lockRelativeChroma:C,lockContrast:u}})}};figma.on("selectionchange",_);figma.on("documentchange",E);figma.on("close",()=>{figma.off("selectionchange",_),figma.off("documentchange",E)});let b;figma.ui.onmessage=o=>{let e;switch(o.type){case"triggerInit":D();break;case"updateShapeColor":e=o.data,I=!0,H(e.newColorRgba,i,e.currentBgOrFg),b&&clearTimeout(b),b=setTimeout(()=>{I=!1},500);break;case"syncFileColorProfile":e=o.data,S=e.fileColorProfile,figma.clientStorage.setAsync("fileColorProfile",e.fileColorProfile);break;case"syncCurrentFillOrStroke":e=o.data,i=e.currentFillOrStroke;break;case"syncCurrentColorModel":e=o.data,d=e.currentColorModel,figma.clientStorage.setAsync("currentColorModel",e.currentColorModel),O();break;case"syncIsContrastInputOpen":e=o.data,h=e.isContrastInputOpen,figma.clientStorage.setAsync("isContrastInputOpen",h),O();break;case"syncLockRelativeChroma":e=o.data,C=e.lockRelativeChroma,figma.clientStorage.setAsync("lockRelativeChroma",e.lockRelativeChroma);break;case"syncCurrentContrastMethod":e=o.data,A=e.currentContrastMethod,figma.clientStorage.setAsync("currentContrastMethod",e.currentContrastMethod);break;case"syncLockContrast":e=o.data,u=e.lockContrast,figma.clientStorage.setAsync("lockContrast",e.lockContrast);break;case"syncIsColorCodeInputsOpen":e=o.data,y=e.isColorCodeInputsOpen,figma.clientStorage.setAsync("isColorCodeInputsOpen",y),O();break}};
