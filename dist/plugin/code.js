"use strict";const M=["BOOLEAN_OPERATION","COMPONENT","ELLIPSE","FRAME","INSTANCE","LINE","POLYGON","RECTANGLE","STAR","TEXT","VECTOR","SHAPE_WITH_TEXT","HIGHLIGHT"];function E(){var i,C,u;const e=figma.currentPage.selection,o={newColorsRgba:{parentFill:null,fill:null,stroke:null},uiMessageCode:null,nodeType:null};if(!e[0])return o.uiMessageCode="no_selection",o;for(const t of e)if(!M.includes(t.type))return o.uiMessageCode="not_supported_type",o.nodeType=t.type,o;const s=e[0].fills[0],l=e[0].strokes[0];if(!s&&!l)return o.uiMessageCode="no_color_in_shape",o;if((s==null?void 0:s.type)!=="SOLID"&&(l==null?void 0:l.type)!=="SOLID")return o.uiMessageCode="no_solid_color",o;if((s==null?void 0:s.type)==="SOLID"&&(o.newColorsRgba.fill={r:s.color.r*255,g:s.color.g*255,b:s.color.b*255,a:Math.round(s.opacity*100)}),(l==null?void 0:l.type)==="SOLID"&&(o.newColorsRgba.stroke={r:l.color.r*255,g:l.color.g*255,b:l.color.b*255,a:Math.round(l.opacity*100)}),e.length>1){let t=0,r=0;for(const k of e)((i=k.fills[0])==null?void 0:i.type)==="SOLID"&&t++,((C=k.strokes[0])==null?void 0:C.type)==="SOLID"&&r++;if(e.length!==t&&e.length!==r)return o.uiMessageCode="not_all_shapes_have_fill_or_stroke",o}if((u=e[0].parent)!=null&&u.fills){let t=e[0].parent;for(;t;)if(t.fills.length!==0){o.newColorsRgba.parentFill={r:t.fills[0].color.r*255,g:t.fills[0].color.g*255,b:t.fills[0].color.b*255};break}else if(t.parent)t=t.parent;else break}return o}function w(e,o,s){var u;const l={r:e.r/255,g:e.g/255,b:e.b/255,a:e.a/100};let i;const C=o+"s";for(const t of figma.currentPage.selection){let r;if(s){for(r=t.parent;r&&((u=r.fills)==null?void 0:u.length)===0;)if(r.parent)r=r.parent;else break;i=JSON.parse(JSON.stringify(r.fills))}else i=JSON.parse(JSON.stringify(t[C]));i[0].color.r=l.r,i[0].color.g=l.g,i[0].color.b=l.b,i[0].opacity=l.a,s?r.fills=i:t[C]=i}}function d(e){const{messageType:o,messageData:s}=e;switch(o){case"init":figma.ui.postMessage({message:o,initData:s});break;case"newColorsRgba":figma.ui.postMessage({message:o,newColorsRgbaData:s});break;case"displayUiMessage":figma.ui.postMessage({message:o,displayUiMessageData:s});break}}let a="fill",p,f,c,S,O;const g={okHsvlWithoutColorCodes:435,okHsvlWithColorCodes:564,okLchWithoutColorCodes:503,okLchWithColorCodes:632};let m=!1,n={parentFill:null,fill:null,stroke:null};const I=["fills","fillStyleId","strokes","strokeWeight"],b=()=>{c?["oklch","oklchCss"].includes(f)?figma.ui.resize(240,g.okLchWithColorCodes):figma.ui.resize(240,g.okHsvlWithColorCodes):["oklch","oklchCss"].includes(f)?figma.ui.resize(240,g.okLchWithoutColorCodes):figma.ui.resize(240,g.okHsvlWithoutColorCodes)},y=()=>{const e=E();return e.uiMessageCode?(d({messageType:"displayUiMessage",messageData:{uiMessageCode:e.uiMessageCode,nodeType:e.nodeType}}),"uiMessageCode sent"):(n=JSON.parse(JSON.stringify(e.newColorsRgba)),"colorsRgba updated")},_=async()=>{figma.editorType==="figma"?p=await figma.clientStorage.getAsync("fileColorProfile")||"rgb":figma.editorType==="figjam"&&(p="rgb"),f=await figma.clientStorage.getAsync("currentColorModel")||"oklchCss",c=await figma.clientStorage.getAsync("showCssColorCodes")||!1,S=await figma.clientStorage.getAsync("lockRelativeChroma")||!1,O=await figma.clientStorage.getAsync("lockContrast")||!1;let e=c?g.okLchWithColorCodes:g.okLchWithoutColorCodes;["okhsv","okhsl"].includes(f)&&(e=c?g.okHsvlWithColorCodes:g.okHsvlWithoutColorCodes),figma.showUI(__html__,{width:240,height:e,themeColors:!0})};_();const P=async()=>{d({messageType:"init",messageData:{figmaEditorType:figma.editorType,fileColorProfile:p,currentColorModel:f,showCssColorCodes:c,lockRelativeChroma:S,lockContrast:O}}),y()!=="uiMessageCode sent"&&(a=n.fill?"fill":"stroke",d({messageType:"newColorsRgba",messageData:{colorsRgba:n,currentFillOrStroke:a}}))},T=()=>{y()!=="uiMessageCode sent"&&(a=n.fill?"fill":"stroke",d({messageType:"newColorsRgba",messageData:{colorsRgba:n,currentFillOrStroke:a}}))},R=e=>{if(m||e.documentChanges[0].type!=="PROPERTY_CHANGE")return;const o=e.documentChanges[0].properties[0];if(I.includes(o)){const s=JSON.parse(JSON.stringify(n));if(y()==="uiMessageCode sent")return;JSON.stringify(s)!==JSON.stringify(n)&&(a==="fill"&&!n.fill?a="stroke":a==="stroke"&&!n.stroke&&(a="fill")),d({messageType:"newColorsRgba",messageData:{colorsRgba:n,currentFillOrStroke:a}})}};figma.on("selectionchange",T);figma.on("documentchange",R);figma.on("close",()=>{figma.off("selectionchange",T),figma.off("documentchange",R)});let h;figma.ui.onmessage=e=>{switch(e.message){case"init":P();break;case"updateShapeColor":m=!0,w(e.newColorRgba,a,e.updateParent),h&&clearTimeout(h),h=setTimeout(()=>{m=!1},500);break;case"syncFileColorProfile":figma.clientStorage.setAsync("fileColorProfile",e.fileColorProfile);break;case"syncCurrentFillOrStroke":a=e.currentFillOrStroke;break;case"syncCurrentColorModel":f=e.currentColorModel,b(),figma.clientStorage.setAsync("currentColorModel",e.currentColorModel);break;case"syncShowCssColorCodes":c=e.showCssColorCodes,b(),figma.clientStorage.setAsync("showCssColorCodes",c);break;case"syncLockRelativeChromaWithPlugin":figma.clientStorage.setAsync("lockRelativeChroma",e.lockRelativeChroma);break;case"syncLockContrastWithPlugin":figma.clientStorage.setAsync("lockContrast",e.lockContrast);break}};
